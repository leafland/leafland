const submitForm=document.querySelector(".submit-form"),send=document.querySelector(".send-order"),treesDisplay=document.querySelector("#form-trees");let gridContentRight=document.querySelector("#grid-content-right"),region=document.querySelector("#region"),emptyMessage=document.querySelector("#empty-message"),submitOrderTrees=JSON.parse(sessionStorage.getItem("trees")),total,freightTotal=document.querySelector("#freight-total"),treeTotal=document.querySelector("#tree-total"),orderTotal=document.querySelector("#order-total");async function populateForm(){let totalFreight=0,freightRegion=[],minimumCharge="";"Northland"!==region.value&&"Manawatu"!==region.value&&"Gisborne"!==region.value&&"pickup"!==region.value.toLowerCase()&&orderFreightData.forEach(datum=>{datum[0]===region.value&&(freightRegion.push({grade:datum[1],price:datum[2]}),"Minimum"===datum[1]&&(minimumCharge=datum[2]))}),totalRetailCost=sessionStorage.getItem("totalRetailCost"),totalWholesaleCost=sessionStorage.getItem("totalWholesaleCost"),total=loggedIn?totalWholesaleCost:totalRetailCost,treesDisplay.innerHTML="";let title=document.createElement("p");title.classList.add("form-trees-title"),title.textContent="Trees:";let poaGrade=!1;submitOrderTrees.forEach(tree=>{let freightPriceValue="";if("Northland"!==region.value&&"Manawatu"!==region.value&&"Gisborne"!==region.value&&"pickup"!==region.value.toLowerCase())for(i=0;i<freightRegion.length;i++)if(-1!==freightRegion[i].grade.search(tree.grade)){freightPriceValue=freightRegion[i].price;break}let formTree=document.createElement("div");formTree.classList.add("form-tree"),formTree.dataset.botanicalName=tree.botanicalName,formTree.dataset.commonName=tree.commonName,formTree.dataset.grade=tree.grade,""===tree.averageHeight?formTree.dataset.averageHeight="-":formTree.dataset.averageHeight=tree.averageHeight,""===tree.standardHeight?formTree.dataset.standardHeight="-":formTree.dataset.standardHeight=tree.standardHeight,formTree.dataset.quantity=tree.quantity,formTree.dataset.retailPrice=tree.retailPrice,formTree.dataset.wholesalePrice=tree.wholesalePrice;let formTreeLeft=document.createElement("div");formTreeLeft.classList.add("form-tree-left");let treeNameDiv=document.createElement("div");treeNameDiv.classList.add("tree-name");let botanicalName=document.createElement("p");if(botanicalName.innerHTML=tree.botanicalName,botanicalName.classList.add("botanical-name"),treeNameDiv.appendChild(botanicalName),""!==tree.commonName){let treeUrlCommon=document.createElement("p");treeUrlCommon.textContent=tree.commonName,treeUrlCommon.classList.add("common-name"),treeNameDiv.appendChild(treeUrlCommon)}let treeInfoDiv=document.createElement("div");treeInfoDiv.classList.add("tree-info");let gradeSize=document.createElement("p");gradeSize.innerHTML=`Grade Size: <span class="accent-color">${tree.grade}</span>`;let averageHeight=document.createElement("p");averageHeight.innerHTML=`Height: <span class="accent-color">${"n/a"===tree.averageHeight.toLowerCase()||""===tree.averageHeight.toLowerCase()||"-"===tree.averageHeight.toLowerCase()?"-":tree.averageHeight+"<span class='lowercase'>m</span>"}</span>`;let standardHeight=document.createElement("p");standardHeight.innerHTML=`Standard Height: <span class="accent-color">${"none"===tree.standardHeight.toLowerCase()||""===tree.standardHeight.toLowerCase()||"-"===tree.standardHeight.toLowerCase()?"-":tree.standardHeight+"<span class='lowercase'>m</span>"}</span>`;let quantity=document.createElement("p");quantity.innerHTML=`Quantity: <span class="accent-color">${tree.quantity}</span>`;let price=document.createElement("p");price.innerHTML=`Price per tree: <span class="accent-color">${loggedIn?tree.wholesalePrice+".00+GST (Wholesale)":tree.retailPrice+".00+GST (Retail)"}</span>`;let freightPrice=document.createElement("p");treeInfoDiv.appendChild(gradeSize),treeInfoDiv.appendChild(averageHeight),treeInfoDiv.appendChild(standardHeight),treeInfoDiv.appendChild(quantity),treeInfoDiv.appendChild(price),treeInfoDiv.appendChild(freightPrice),formTreeLeft.appendChild(treeInfoDiv);let formTreeRight=document.createElement("div");formTreeRight.classList.add("form-tree-right");let treeImage=document.createElement("img");treeImage.src=`https://images.leafland.co.nz/rs,s:150/q:75/o:auto/?image=https://files.leafland.co.nz/${tree.mainImage}`,treeImage.width="150",treeImage.height="150",treeImage.alt=`${tree.url.replace(/\/trees\//g,"").replace(/\//g,"").replace(/-/g," ")}`,treeImage.loading="lazy",formTreeRight.appendChild(treeImage),formTreeRight.appendChild(treeNameDiv),formTree.appendChild(formTreeLeft),formTree.appendChild(formTreeRight),treesDisplay.appendChild(formTree),"Northland"!==region.value&&"Manawatu"!==region.value&&"Gisborne"!==region.value&&"Pickup"!==region.value?"P.O.A"===freightPriceValue?(poaGrade=!0,freightPrice.innerHTML='<p class="freight-price" data-freight-price="P.O.A">Freight per tree: <span class="accent-color">P.O.A</span></p>'):(freightPrice.innerHTML=`<p class="freight-price" data-freight-price="${freightPriceValue}">Freight per tree: <span class="accent-color">${freightPriceValue}+GST</span></p>`,totalFreight+=parseInt(tree.quantity,10)*parseFloat(freightPriceValue.slice(1))):freightPrice.innerHTML='<p class="freight-price" data-freight-price="-">Freight per tree: <span class="accent-color">-</span></p>'}),"Northland"!==region.value&&"Manawatu"!==region.value&&"Gisborne"!==region.value&&"Pickup"!==region.value?(poaGrade?(totalFreight<=parseInt(minimumCharge.slice(1),10)?freightTotal.innerHTML=`Freight Total: <span class="accent-color">${minimumCharge}+GST (minimum freight charge, excluding freight for P.O.A grades)</span>`:freightTotal.innerHTML=`Freight Total: <span class="accent-color">$${totalFreight.toFixed(2)}+GST (excluding freight for P.O.A grades)</span>`,orderTotal.innerHTML=`Order Total: <span class="accent-color">$${-1!==freightTotal.textContent.search("(minimum freight charge)")?(parseInt(total,10)+parseInt(minimumCharge.slice(1),10)).toFixed(2):(parseInt(total,10)+totalFreight).toFixed(2)}+GST (excluding freight for P.O.A grades)</span>`):(totalFreight<=parseInt(minimumCharge.slice(1),10)?freightTotal.innerHTML=`Freight Total: <span class="accent-color">${minimumCharge}+GST (minimum freight charge)</span>`:freightTotal.innerHTML=`Freight Total: <span class="accent-color">$${totalFreight.toFixed(2)}+GST</span>`,orderTotal.innerHTML=`Order Total: <span class="accent-color">$${-1!==freightTotal.textContent.search("(minimum freight charge)")?(parseInt(total,10)+parseInt(minimumCharge.slice(1),10)).toFixed(2):(parseInt(total,10)+totalFreight).toFixed(2)}+GST</span>`),treeTotal.innerHTML=`Tree Total: <span class="accent-color">$${total}.00+GST</span>`):(freightTotal.innerHTML='Freight Total: <span class="accent-color">-</span>',treeTotal.innerHTML=`Tree Total: <span class="accent-color">$${parseInt(total,10).toFixed(2)}+GST</span>`,orderTotal.innerHTML=`Order Total: <span class="accent-color">$${parseInt(total,10).toFixed(2)}+GST</span>`)}total=loggedIn?totalWholesaleCost:totalRetailCost,async function(){0===submitOrderTrees.length?(submitForm.style.setProperty("display","none"),emptyMessage.style.setProperty("display","block")):await populateForm()}(),window.addEventListener("storage",event=>{"trees"===event.key&&(submitOrderTrees=JSON.parse(sessionStorage.getItem("trees")),0!==submitOrderTrees.length?(emptyMessage.style.setProperty("display","none"),total=loggedIn?totalWholesaleCost:totalRetailCost,populateForm(),submitForm.style.setProperty("display","grid")):(emptyMessage.style.setProperty("display","block"),submitForm.style.setProperty("display","none")))}),window.addEventListener("orderUpdated",()=>{submitOrderTrees=JSON.parse(sessionStorage.getItem("trees")),0!==submitOrderTrees.length?(emptyMessage.style.setProperty("display","none"),total=loggedIn?totalWholesaleCost:totalRetailCost,populateForm(),submitForm.style.setProperty("display","grid")):(emptyMessage.style.setProperty("display","block"),submitForm.style.setProperty("display","none"))}),region.addEventListener("input",()=>{populateForm()}),submitForm.addEventListener("submit",event=>{event.preventDefault();let treeEmailData="";document.querySelectorAll(".form-tree").forEach(child=>{treeEmailData+=`\n    \n    <tr>\n\n          <td>\n\n            <b>${child.dataset.botanicalName}</b>\n\n            <b>(${child.dataset.commonName})</b>\n\n          </td>\n          \n          <td>\n            \n            <b>${child.dataset.grade}</b>\n\n          </td>\n          \n          <td>\n\n            <b>${"n/a"===child.dataset.averageHeight.toLowerCase()||""===child.dataset.averageHeight.toLowerCase()||"-"===child.dataset.averageHeight.toLowerCase()?"-":child.dataset.averageHeight+"m"}</b>\n\n          </td>\n          \n          <td>\n          \n          <b>${"none"===child.dataset.standardHeight.toLowerCase()||""===child.dataset.standardHeight.toLowerCase()||"-"===child.dataset.standardHeight.toLowerCase()?"-":child.dataset.standardHeight+"m"}</b>\n          </td>\n          \n          <td>\n\n          <b>${child.dataset.quantity}</b>\n          \n          </td>\n          \n          <td>\n\n          <b>${loggedIn?child.dataset.wholesalePrice+".00+GST (Wholesale)":child.dataset.retailPrice+".00+GST (Retail)"}</b>\n          \n          </td>\n          \n          <td>\n\n          <b>${child.querySelector(".freight-price").dataset.freightPrice}</b>\n          \n          </td>\n          \n      </tr>\n    \n    `});let freightTotal=document.querySelector("#freight-total"),treeTotal=document.querySelector("#tree-total"),orderTotal=document.querySelector("#order-total");send.textContent="Submitting...",send.style.setProperty("background","var(--button-background-color-hover"),send.style.setProperty("color","var(--button-text-color-hover"),send.style.setProperty("cursor","default");const{name:name,email:email,phone:phone,streetAddress:streetAddress,townCity:townCity,returningCustomer:returningCustomer,notes:notes}=event.target,internalBody=JSON.stringify({fromAddress:"administrator@leafland.co.nz",fromName:"Admin | Leafland",toAddress:"sales@leafland.co.nz",replyToAddress:email.value,replyToName:name.value,subject:"Order from "+name.value,html:`<!DOCTYPE html><html><head><style>body{word-break:break-word} h2{margin-top: 50px} td,th{border:2px solid #000;padding:10px} table{border-collapse: collapse;}</style></head><body><h1>Order from ${"No"===returningCustomer.value?name.value+" (New Customer)":name.value+" (Returning Customer)"}</h1><h2>CONTACT AND DELIVERY DETAILS</h2><p>${name.value}</p><p>${email.value}</p><p>${phone.value}</p><p>${streetAddress.value}</p><p>${townCity.value}</p><h2>NOTES</h2><p>${""!==notes.value?notes.value:"No notes"}</p><h2>TREES</h2><table><tr><th>NAME</th><th>GRADE</th><th>HEIGHT</th><th>STANDARD HEIGHT</th><th>QUANTITY</th><th>PRICE PER TREE</th><th>FREIGHT PER TREE</th></tr>${treeEmailData}</table><h2>TOTALS</h2><p><b>FREIGHT TOTAL:</b> ${freightTotal.innerHTML.replace(/Freight Total: <span class="accent-color">/,"").replace(/<\/span>/,"")} (Region: <b>${region.value}</b>)</p><p><b>TREE TOTAL:</b> ${treeTotal.innerHTML.replace(/Tree Total: <span class="accent-color">/,"").replace(/<\/span>/,"")}</p><p><b>ORDER TOTAL:</b> ${orderTotal.innerHTML.replace(/Order Total: <span class="accent-color">/,"").replace(/<\/span>/,"")}</p></body></html>`,isOpenTracked:!1}),externalBody=JSON.stringify({fromAddress:"administrator@leafland.co.nz",fromName:"Admin | Leafland",toAddress:email.value,replyToAddress:"sales@leafland.co.nz",replyToName:"Sales | Leafland",subject:"Thanks for your order!",html:`<!DOCTYPE html><html><head><style>body{word-break:break-word} h2{margin-top: 50px} td,th{border:2px solid #000;padding:10px} table{border-collapse: collapse;}</style></head><body><h1>Thanks for your order ${name.value}!</h1><p>We are currently processing your order and will be in touch regarding payment and delivery.</p><h2>CONTACT AND DELIVERY DETAILS</h2><p>${name.value}</p><p>${email.value}</p><p>${phone.value}</p><p>${streetAddress.value}</p><p>${townCity.value}</p><h2>NOTES</h2><p>${""!==notes.value?notes.value:"No notes"}</p><h2>TREES</h2><table><tr><th>NAME</th><th>GRADE</th><th>HEIGHT</th><th>STANDARD HEIGHT</th><th>QUANTITY</th><th>PRICE PER TREE</th><th>FREIGHT PER TREE</th></tr>${treeEmailData}</table><h2>TOTALS</h2><p><b>FREIGHT TOTAL:</b> ${freightTotal.innerHTML.replace(/Freight Total: <span class="accent-color">/,"").replace(/<\/span>/,"")} (Region: <b>${region.value}</b>)</p><p><b>TREE TOTAL:</b> ${treeTotal.innerHTML.replace(/Tree Total: <span class="accent-color">/,"").replace(/<\/span>/,"")}</p><p><b>ORDER TOTAL:</b> ${orderTotal.innerHTML.replace(/Order Total: <span class="accent-color">/,"").replace(/<\/span>/,"")}</p></body></html>`,isOpenTracked:!1}),internalRequestOptions={method:"POST",mode:"no-cors",body:internalBody},externalRequestOptions={method:"POST",mode:"no-cors",body:externalBody};!async function(){await fetch("https://internal-order.leafland.co.nz",internalRequestOptions).then(response=>{}).catch(error=>{}),await fetch("https://external-order.leafland.co.nz",externalRequestOptions).then(response=>{}).catch(error=>{}),sessionStorage.setItem("submittedOrder","true"),window.location.reload()}()}),document.querySelector("#close-submit-order").addEventListener("click",()=>{document.body.classList.remove("submit-order-open")}),document.querySelector("#submit-order-back").addEventListener("click",()=>{document.body.classList.remove("submit-order-open"),document.body.classList.add("order-open")});