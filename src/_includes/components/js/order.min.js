let orderContent=document.querySelector("#order-content"),openOrder=document.querySelector("#open-order"),closeOrder=document.querySelector("#close-order"),submitOrder=document.querySelector("#submit-order"),orderRegion=document.querySelector("#order-region"),orderRegionSelect=document.querySelector(".order-region-select"),totalCostText=document.querySelector("#order-overlay-total"),productList=document.createElement("ul");productList.classList.add("order-product-list");const orderUpdated=new Event("orderUpdated");let totalRetailCost=sessionStorage.getItem("totalRetailCost"),totalWholesaleCost=sessionStorage.getItem("totalWholesaleCost"),orderTrees,orderSticky=document.querySelector("#order-sticky"),orderFreightData=[],orderTotalFreight=0,orderPoaGrade=!1,orderMinimumCharge="";async function getOrderFreightData(){orderFreightData=await fetch("/public/freight.json").then(response=>response.json()).then(data=>data).catch(error=>{})}function updateOrderTotal(){let total="";totalRetailCost=sessionStorage.getItem("totalRetailCost"),totalWholesaleCost=sessionStorage.getItem("totalWholesaleCost"),total=loggedIn?totalWholesaleCost:totalRetailCost,"Northland"!==orderRegion.value&&"Manawatu"!==orderRegion.value&&"Gisborne"!==orderRegion.value&&"Pickup"!==orderRegion.value?orderPoaGrade?orderTotalFreight<=parseInt(orderMinimumCharge.slice(1),10)?totalCostText.innerHTML=`Total: <span class="accent-color">$${parseInt(total,10)+parseInt(orderMinimumCharge.slice(1),10)}+GST (includes minimum freight charge, excluding freight for P.O.A grades)</span>`:totalCostText.innerHTML=`Total: <span class="accent-color">$${(parseInt(total,10)+orderTotalFreight).toFixed(2)}+GST (excluding freight for P.O.A grades)</span>`:orderTotalFreight<=parseInt(orderMinimumCharge.slice(1),10)?totalCostText.innerHTML=`Total: <span class="accent-color">$${parseInt(total,10)+parseInt(orderMinimumCharge.slice(1),10)}+GST (includes minimum freight charge)</span>`:totalCostText.innerHTML=`Total: <span class="accent-color">$${(parseInt(total,10)+orderTotalFreight).toFixed(2)}+GST (including freight)</span>`:totalCostText.innerHTML=`Total: <span class="accent-color">$${parseInt(total,10).toFixed(2)}+GST (excluding freight)</span>`}function displayEmptyOrder(){orderContent.contains(productList)&&orderContent.removeChild(productList),orderContent.innerHTML="";let empty=document.createElement("p");empty.textContent="No trees in order.",empty.classList.add("empty-message"),empty.classList.add("paragraph-title"),orderContent.appendChild(empty),orderSticky.style.setProperty("visibility","hidden"),orderRegionSelect.style.setProperty("visibility","hidden"),sessionStorage.setItem("totalRetailCost","0"),sessionStorage.setItem("totalWholesaleCost","0"),submitOrder.classList.add("disabled")}async function updateOrder(){if(orderTrees=JSON.parse(sessionStorage.getItem("trees")),0!==orderTrees.length){orderTotalFreight=0;let freightRegion=[];orderMinimumCharge="","Northland"!==orderRegion.value&&"Manawatu"!==orderRegion.value&&"Gisborne"!==orderRegion.value&&"pickup"!==orderRegion.value.toLowerCase()&&orderFreightData.forEach(datum=>{datum[0]===orderRegion.value&&(freightRegion.push({grade:datum[1],price:datum[2]}),"Minimum"===datum[1]&&(orderMinimumCharge=datum[2]))}),totalRetailCost=sessionStorage.getItem("totalRetailCost"),totalWholesaleCost=sessionStorage.getItem("totalWholesaleCost"),orderSticky.style.setProperty("visibility","visible"),orderRegionSelect.style.setProperty("visibility","visible");let emptyOrder=document.querySelector(".empty-message");orderContent.contains(emptyOrder)&&orderContent.removeChild(emptyOrder),submitOrder.classList.remove("disabled"),productList.innerHTML="",orderPoaGrade=!1,orderTrees.forEach(tree=>{let freightPriceValue="";if("Northland"!==orderRegion.value&&"Manawatu"!==orderRegion.value&&"Gisborne"!==orderRegion.value&&"pickup"!==orderRegion.value.toLowerCase())for(i=0;i<freightRegion.length;i++)if(-1!==freightRegion[i].grade.search(tree.grade)){freightPriceValue=freightRegion[i].price;break}let listItem=document.createElement("li");listItem.classList.add("order-product");let leftDiv=document.createElement("div");leftDiv.classList.add("order-product-left");let rightDiv=document.createElement("div");rightDiv.classList.add("order-product-right");let itemImage=document.createElement("img");itemImage.src=`https://img.imageboss.me/leafland/width/150/quality:75,format:auto/${tree.mainImage}`,itemImage.width="150",itemImage.height="150",itemImage.loading="lazy",itemImage.alt=`${tree.url.replace(/\/trees\//g,"").replace(/\//g,"").replace(/-/g," ")}`;let itemBotanicalName=document.createElement("p");itemBotanicalName.innerHTML=tree.botanicalName,itemBotanicalName.classList.add("order-botanical-name");let nameDiv=document.createElement("div");if(nameDiv.classList.add("order-product-name"),nameDiv.appendChild(itemBotanicalName),""!==tree.commonName){let itemCommonName=document.createElement("p");itemCommonName.textContent=tree.commonName,itemCommonName.classList.add("order-common-name"),nameDiv.appendChild(itemCommonName)}let itemDiv=document.createElement("div");itemDiv.classList.add("order-item-details");let itemGrade=document.createElement("p");itemGrade.innerHTML=`Grade Size: <span class="accent-color">${tree.grade}</span>`;let itemAverageHeight=document.createElement("p");itemAverageHeight.innerHTML=`Height: <span class="accent-color">${"n/a"===tree.averageHeight.toLowerCase()||""===tree.averageHeight.toLowerCase()?"-":tree.averageHeight+"<span class='lowercase'>m</span>"}</span>`;let itemStandardHeight=document.createElement("p");null!==tree.standardHeight.match(/\d+/g)?itemStandardHeight.innerHTML=`Standard Height: <span class="accent-color">${tree.standardHeight+"<span class='lowercase'>m</span>"}</span>`:itemStandardHeight.innerHTML='Standard Height: <span class="accent-color">-</span>';let itemPrice=document.createElement("p");loggedIn?itemPrice.innerHTML=`Price per tree: <span class="accent-color">${tree.wholesalePrice}+GST (Wholesale)</span>`:itemPrice.innerHTML=`Price per tree: <span class="accent-color">${tree.retailPrice}+GST (Retail)</span>`;let freightPrice=document.createElement("p");"Northland"!==orderRegion.value&&"Manawatu"!==orderRegion.value&&"Gisborne"!==orderRegion.value&&"Pickup"!==orderRegion.value?"P.O.A"===freightPriceValue?(orderPoaGrade=!0,freightPrice.innerHTML='<p>Freight per tree: <span class="accent-color">P.O.A</span></p>'):(freightPrice.innerHTML=`<p>Freight per tree: <span class="accent-color">${freightPriceValue}+GST</span></p>`,orderTotalFreight+=parseInt(tree.quantity,10)*parseFloat(freightPriceValue.slice(1))):freightPrice.innerHTML='<p>Freight per tree: <span class="accent-color">-</span></p>';let itemQuantity=document.createElement("input");itemQuantity.type="number",itemQuantity.value=tree.quantity,itemQuantity.min="1",itemQuantity.max=tree.maxQuantity,itemQuantity.inputMode="numeric",itemQuantity.classList.add("order-quantity"),itemQuantity.dataset.grade=tree.grade,itemQuantity.dataset.height=tree.averageHeight,itemQuantity.dataset.standardHeight=tree.standardHeight,itemQuantity.addEventListener("change",()=>{parseInt(itemQuantity.value)<1?itemQuantity.value=1:parseInt(itemQuantity.value)>parseInt(tree.maxQuantity)&&(itemQuantity.value=parseInt(tree.maxQuantity));for(let i=0;i<orderTrees.length;i++)if(orderTrees[i].botanicalName===tree.botanicalName&&orderTrees[i].grade===itemQuantity.dataset.grade&&orderTrees[i].averageHeight===itemQuantity.dataset.height&&orderTrees[i].standardHeight===itemQuantity.dataset.standardHeight){orderTrees[i].quantity=itemQuantity.value;break}for(totalWholesaleCost=0,totalRetailCost=0,orderTotalFreight=0,i=0;i<orderTrees.length;i++){if(totalWholesaleCost+=orderTrees[i].quantity*parseInt(orderTrees[i].wholesalePrice.slice(1),10),totalRetailCost+=orderTrees[i].quantity*parseInt(orderTrees[i].retailPrice.slice(1),10),freightPriceValue="","Northland"!==orderRegion.value&&"Manawatu"!==orderRegion.value&&"Gisborne"!==orderRegion.value&&"pickup"!==orderRegion.value.toLowerCase())for(j=0;j<freightRegion.length;j++)if(-1!==freightRegion[j].grade.search(orderTrees[i].grade)){freightPriceValue=freightRegion[j].price;break}"Northland"!==orderRegion.value&&"Manawatu"!==orderRegion.value&&"Gisborne"!==orderRegion.value&&"Pickup"!==orderRegion.value&&("P.O.A"===freightPriceValue||(orderTotalFreight+=parseInt(orderTrees[i].quantity,10)*parseFloat(freightPriceValue.slice(1))))}updateStorage(),updateOrderTotal(),window.dispatchEvent(orderUpdated)});let removeItem=document.createElement("button");removeItem.textContent="Remove",removeItem.classList.add("remove-item"),removeItem.addEventListener("click",()=>{for(let i=0;i<orderTrees.length;i++)if(orderTrees[i].botanicalName===tree.botanicalName&&orderTrees[i].grade===itemQuantity.dataset.grade&&orderTrees[i].averageHeight===itemQuantity.dataset.height&&orderTrees[i].standardHeight===itemQuantity.dataset.standardHeight){orderTrees.splice(i,1);break}for(totalWholesaleCost=0,totalRetailCost=0,orderTotalFreight=0,i=0;i<orderTrees.length;i++){if(totalWholesaleCost+=orderTrees[i].quantity*parseInt(orderTrees[i].wholesalePrice.slice(1),10),totalRetailCost+=orderTrees[i].quantity*parseInt(orderTrees[i].retailPrice.slice(1),10),freightPriceValue="","Northland"!==orderRegion.value&&"Manawatu"!==orderRegion.value&&"Gisborne"!==orderRegion.value&&"pickup"!==orderRegion.value.toLowerCase())for(j=0;j<freightRegion.length;j++)if(-1!==freightRegion[j].grade.search(orderTrees[i].grade)){freightPriceValue=freightRegion[j].price;break}"Northland"!==orderRegion.value&&"Manawatu"!==orderRegion.value&&"Gisborne"!==orderRegion.value&&"Pickup"!==orderRegion.value&&("P.O.A"===freightPriceValue||(orderTotalFreight+=parseInt(orderTrees[i].quantity,10)*parseFloat(freightPriceValue.slice(1))))}updateStorage(),updateOrder(),window.dispatchEvent(orderUpdated)}),leftDiv.appendChild(itemDiv),itemDiv.appendChild(itemGrade),itemDiv.appendChild(itemAverageHeight),itemDiv.appendChild(itemStandardHeight),itemDiv.appendChild(itemPrice),itemDiv.appendChild(freightPrice),leftDiv.appendChild(itemQuantity),leftDiv.appendChild(removeItem),rightDiv.appendChild(itemImage),rightDiv.appendChild(nameDiv),listItem.appendChild(leftDiv),listItem.appendChild(rightDiv),productList.appendChild(listItem)}),orderContent.appendChild(productList),updateOrderTotal()}else displayEmptyOrder();window.dispatchEvent(orderUpdated)}function updateStorage(){sessionStorage.setItem("trees",JSON.stringify(orderTrees)),sessionStorage.setItem("totalRetailCost",JSON.stringify(totalRetailCost)),sessionStorage.setItem("totalWholesaleCost",JSON.stringify(totalWholesaleCost))}openOrder.addEventListener("click",()=>{document.body.classList.add("order-open")}),closeOrder.addEventListener("click",()=>{document.body.classList.remove("order-open")}),window.addEventListener("storage",()=>{"true"===sessionStorage.getItem("loggedIn")?loggedIn=!0:loggedIn=!1,updateOrder()}),window.addEventListener("productAdded",()=>{updateOrder()}),window.addEventListener("orderSent",()=>{updateOrder()}),async function init(){updateOrder(),getOrderFreightData()}(),orderRegion.addEventListener("input",()=>{updateOrder()}),submitOrder.addEventListener("click",()=>{document.body.classList.remove("order-open"),document.body.classList.add("submit-order-open")}),document.body.dataset.code&&(document.querySelector("#stock-table-back").style.setProperty("display","inline-block"),document.querySelector("#stock-table-back").addEventListener("click",()=>{document.body.classList.remove("order-open"),document.body.classList.add("stock-table-open")}));